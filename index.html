<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
    <head>
        <title>
            School of PureScript
        </title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.5/flatly/bootstrap.min.css" type="text/css">
        <style>
            .example {
                box-shadow: 0 0 3px gray;
                overflow: hidden;
            }
            
            .example .ace_editor {
                height: 250px;
                bottom: 0;
                overflow: scroll;
                font-family: monospace;
                font-size: 16px;
                border: 0;
                resize: none;
                outline: 0;
                outline: none;
            }
            
            .example .console {
                border-top: 1px dashed lightgray;
                overflow: scroll;
                min-height: 50px;
                margin: 0;
            }
            
            .console iframe {
                width: 100%;
                border: 0;
                height: 50px;
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js" type="text/javascript"></script>
        <script src="assets/debounce.js" type="text/javascript"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.js" type="text/javascript"></script>
        <script src="assets/commonmark.min.js" type="text/javascript"></script>
        <script type="text/javascript">
        $(function() {
            $.ajax({
                url: 'https://gist.githubusercontent.com/paf31/f0aa7cc2bf355fb80ac3/raw/bab2313113513a0ccbc6949011b6d41f30766c59/school.md',
                method: 'GET',
                dataType: 'text',
                crossDomain: true,
                success: function(res) {
                    var reader = new commonmark.Parser();
                    var writer = new commonmark.HtmlRenderer();
                    var parsed = reader.parse(res); 
                    
                    var walker = parsed.walker();
                    var event, node;

                    while ((event = walker.next())) {
                        node = event.node;
                        if (event.entering && node.type === 'CodeBlock') {
                            if (node.info.indexOf("executable") >= 0) {
                                var info = node.info.split(/\s+/);
                                info[0] = info[0] + "-executable";
                                node.info = info.join(" ");
                            }
                        }
                    }
                    
                    var rendered = writer.render(parsed);
                    
                    $('#content').html(rendered);
                    
                    makeEditable();
                },
                error: function() {
                    console.error('Cannot load gist');
                }
            });
        });
            
        function makeEditable() {
            $('#content pre code[class^=language-purescript]').each(function() {
                
                // Get the additional code for this block and save it.
                var prev = $(this).parent().prevAll('pre').children('code[class^=language-purescript]').map(function() {
                    return $(this).text();
                });
                var additional = Array.prototype.join.call(Array.prototype.reverse.call(prev), "\n");
                
                $(this).data('additional', additional);
            });
        
            $('#content pre code.language-purescript-executable').each(function() {
                
                // Get the additional code
                var additional = $(this).data('additional');
                
                // Replace the pre element with a div
                var code = $(this).text();
                var $example = $('<p>').addClass('example');
                $(this).parent().replaceWith($example);
                
                // Add a div which will act as the placeholder for the Ace editor
                var $editor = $('<div>').appendTo($example);
                
                var $code = $('<textarea>')
                                .addClass('code')
                                .css({ display: 'none' })
                                .val(code)
                                .appendTo($example);
                
                // Add a div for the console
                var $console = $('<div>').addClass('console well').appendTo($example);

                // Set up the Ace editor
                var editor = ace.edit($code.get(0));
                editor.setTheme('ace/theme/clouds');
                editor.renderer.setShowGutter(false);

                var session = editor.getSession();

                session.setMode('ace/mode/haskell');
                session.setValue(code);
                session.setUseWrapMode(true);
                session.setWrapLimitRange();
                
                // Debounce the input event, and recompile code on changes.
                var debounced = $.debounce(500, function() {
            
                    execute();
                });
                
                session.on('change', function() {
                    
                    $code.val(editor.getSession().getValue());
                    debounced();
                });
                
                var execute = function() {
                    var code = $code.val();
            
                    $.ajax({
                        url: 'http://try.purescript.org/compile/text',
                        dataType: 'json',
                        data: [additional, code].join("\n"),
                        method: 'POST',
                        crossDomain: true,
                        success: function(res) {
                            if (res.error) {
                                $console.empty().append($('<pre>').append($('<code>').text(res.error)));
                            } else if (res.js) {
                              var $iframe = $('<iframe>');
        
                              $console.empty().append($iframe);
        
                              var iframe = $iframe.get(0).contentWindow.document;
        
                              iframe.open();
                              iframe.write(
                                  [ '<html>'
                                  , '  <head>'
                                  , '    <title>Try PureScript</title>'
                                  , '  </head>'
                                  , '  <body>'
                                  , '    <div id="console"></div>'
                                  , '  </body>'
                                  , '</html>'
                                  ].join('\n'));
            
                                var initScript = 
                                    [ 'var console = {'
                                  , '  log: function(s) {'
                                  , '    var text = document.createTextNode(s);'
                                  , '    var code = document.createElement("code");'
                                  , '    var pre = document.createElement("pre");'
                                  , '    pre.appendChild(code);'
                                  , '    code.appendChild(text);'
                                  , '    document.getElementById("console").appendChild(pre);'
                                  , '  }'
                                  , '};'
                                  ].join('\n');
        
                              var scripts = [initScript, res.js];
        
                              for (var i = 0; i < scripts.length; i++) {
                                  var script = iframe.createElement('script');
                                  script.appendChild(iframe.createTextNode(scripts[i]));
                                  var head = iframe.getElementsByTagName('head')[0];
                                  head.appendChild(script);
                              }
                           }
                        },
                        error: function(res) {
                            $console.empty()
                                .append($('<pre>').append($('<code>').append(res)));
                        }
                    });  
                };
                
                // Compile the initial code.
                execute();
            });
        };
        </script>
    </head>
    <body>
        <div class="navbar navbar-default">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">School of PureScript</a>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="content"></div>
        </div>
    </body>
</html>
